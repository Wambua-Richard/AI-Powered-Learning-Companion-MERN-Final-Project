# API Documentation for AI-Powered Learning Companion
# This OpenAPI specification defines the REST API endpoints, request/response schemas, and authentication methods.
# It covers user authentication, lesson management, quiz handling, and AI-powered features like explanations and quiz generation.
# The API uses JWT for authentication and role-based access control for certain endpoints.
# OpenAPI snippet
 
openapi: 3.0.3
info:
  title: AI-Powered Learning Companion API
  version: "1.0.0"
  description: |
    REST API for the AI-Powered Learning Companion.  
    Provides endpoints for authentication, lessons management, quizzes, and AI-powered features (explanations, quiz generation, summarization).
servers:
  - url: https://api.your-domain.com/api
    description: Production server
  - url: http://localhost:5000/api
    description: Local development server

tags:
  - name: Auth
    description: Authentication and user profile
  - name: Lessons
    description: Lesson content CRUD and listing
  - name: Quizzes
    description: Quiz creation, generation and submission
  - name: AI
    description: AI-powered endpoints (explain, generate quiz, summarize)
  - name: Users
    description: User management and progress

paths:

  /auth/register:
    post:
      tags: [Auth]
      summary: Register a new user
      description: Create a new user account. Role defaults to `student` unless `role` is set to `teacher` or `admin`.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RegisterRequest'
      responses:
        '201':
          description: User created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthSuccessResponse'
        '400':
          description: Validation error (e.g. email already exists)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /auth/login:
    post:
      tags: [Auth]
      summary: Login user
      description: Authenticate a user and return a JWT token.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/LoginRequest'
      responses:
        '200':
          description: Login successful (returns JWT)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthSuccessResponse'
        '400':
          description: Invalid credentials
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /auth/profile:
    get:
      tags: [Auth]
      summary: Get current user profile
      security:
        - bearerAuth: []
      responses:
        '200':
          description: User profile
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ProfileResponse'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /lessons:
    get:
      tags: [Lessons]
      summary: List lessons
      description: Returns a paginated list of lessons. Supports filtering by tag, difficulty, or author.
      parameters:
        - $ref: '#/components/parameters/query_page'
        - $ref: '#/components/parameters/query_limit'
        - name: tag
          in: query
          schema:
            type: string
          description: Filter by tag
        - name: difficulty
          in: query
          schema:
            type: string
            enum: [easy, medium, hard]
          description: Filter by difficulty
        - name: author
          in: query
          schema:
            type: string
          description: Filter by author ID
      responses:
        '200':
          description: List of lessons
          content:
            application/json:
              schema:
                type: object
                properties:
                  total:
                    type: integer
                  page:
                    type: integer
                  limit:
                    type: integer
                  lessons:
                    type: array
                    items:
                      $ref: '#/components/schemas/Lesson'
        '500':
          $ref: '#/components/responses/InternalError'

    post:
      tags: [Lessons]
      summary: Create a new lesson
      description: Only authenticated users (teachers/admin) should create lessons. Use role-based middleware.
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/LessonCreate'
      responses:
        '201':
          description: Lesson created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Lesson'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'

  /lessons/{id}:
    get:
      tags: [Lessons]
      summary: Get lesson by ID
      parameters:
        - $ref: '#/components/parameters/LessonId'
      responses:
        '200':
          description: Lesson details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Lesson'
        '404':
          $ref: '#/components/responses/NotFound'

    put:
      tags: [Lessons]
      summary: Update a lesson
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/LessonId'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/LessonCreate'
      responses:
        '200':
          description: Lesson updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Lesson'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'

    delete:
      tags: [Lessons]
      summary: Delete a lesson
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/LessonId'
      responses:
        '200':
          description: Lesson deleted
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  message:
                    type: string
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'

  /ai/explain:
    post:
      tags: [AI]
      summary: Ask AI to explain a topic or text
      description: Sends a prompt to the AI service and returns an explanation. The backend should sanitize and log prompts and responses.
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AIExplainRequest'
      responses:
        '200':
          description: AI explanation
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AIExplainResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '503':
          description: AI provider unavailable
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /ai/generate-quiz:
    post:
      tags: [AI]
      summary: Generate a quiz from a topic or lesson
      description: The AI generates a quiz in structured JSON. Responses must be validated before saving.
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AIQuizRequest'
      responses:
        '200':
          description: Generated quiz
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/GeneratedQuizResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '503':
          $ref: '#/components/responses/ServiceUnavailable'

  /ai/summarize:
    post:
      tags: [AI]
      summary: Summarize text or lesson content
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AISummarizeRequest'
      responses:
        '200':
          description: Summary returned
          content:
            application/json:
              schema:
                type: object
                properties:
                  summary:
                    type: string
        '400':
          $ref: '#/components/responses/BadRequest'

  /quizzes:
    get:
      tags: [Quizzes]
      summary: List quizzes
      responses:
        '200':
          description: List of quizzes
          content:
            application/json:
              schema:
                type: object
                properties:
                  quizzes:
                    type: array
                    items:
                      $ref: '#/components/schemas/QuizSummary'

    post:
      tags: [Quizzes]
      summary: Create a quiz (manual)
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/QuizCreate'
      responses:
        '201':
          description: Quiz created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Quiz'

  /quizzes/{id}:
    get:
      tags: [Quizzes]
      summary: Get quiz by ID
      parameters:
        - $ref: '#/components/parameters/QuizId'
      responses:
        '200':
          description: Quiz details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Quiz'
        '404':
          $ref: '#/components/responses/NotFound'

  /quizzes/{id}/submit:
    post:
      tags: [Quizzes]
      summary: Submit quiz answers
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/QuizId'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/QuizSubmission'
      responses:
        '200':
          description: Quiz results (score and feedback)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/QuizResult'
        '400':
          $ref: '#/components/responses/BadRequest'
        '404':
          $ref: '#/components/responses/NotFound'

components:

  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

  parameters:
    LessonId:
      name: id
      in: path
      required: true
      schema:
        type: string
      description: Lesson object id (MongoDB ObjectId)
    QuizId:
      name: id
      in: path
      required: true
      schema:
        type: string
      description: Quiz object id (MongoDB ObjectId)
    query_page:
      name: page
      in: query
      schema:
        type: integer
        default: 1
      description: Page number for pagination
    query_limit:
      name: limit
      in: query
      schema:
        type: integer
        default: 20
      description: Page size for pagination

  responses:
    BadRequest:
      description: Invalid request
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
    Unauthorized:
      description: Authentication required or invalid token
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
    NotFound:
      description: Resource not found
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
    InternalError:
      description: Internal server error
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
    ServiceUnavailable:
      description: External service (e.g., AI provider) unavailable
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'

  schemas:

    ErrorResponse:
      type: object
      properties:
        success:
          type: boolean
          example: false
        message:
          type: string
          example: "Invalid input"
        errors:
          type: array
          items:
            type: string

    RegisterRequest:
      type: object
      required:
        - name
        - email
        - password
      properties:
        name:
          type: string
          example: "Jane Doe"
        email:
          type: string
          format: email
          example: "jane@example.com"
        password:
          type: string
          format: password
          example: "P@ssw0rd!"
        role:
          type: string
          enum: [student, teacher, admin]
          example: student

    LoginRequest:
      type: object
      required:
        - email
        - password
      properties:
        email:
          type: string
          format: email
          example: "jane@example.com"
        password:
          type: string
          format: password
          example: "P@ssw0rd!"

    AuthSuccessResponse:
      type: object
      properties:
        success:
          type: boolean
          example: true
        token:
          type: string
          example: "eyJhbGci..."
        user:
          type: object
          properties:
            id:
              type: string
              example: "650a..."
            name:
              type: string
              example: "Jane Doe"
            email:
              type: string
              example: "jane@example.com"
            role:
              type: string
              example: "student"

    ProfileResponse:
      type: object
      properties:
        success:
          type: boolean
          example: true
        user:
          type: object
          properties:
            id: { type: string }
            name: { type: string }
            email: { type: string }
            role: { type: string }
            createdAt:
              type: string
              format: date-time

    Lesson:
      type: object
      properties:
        id:
          type: string
          example: "650b..."
        title:
          type: string
          example: "Photosynthesis Basics"
        content:
          type: string
          example: "Photosynthesis is the process..."
        tags:
          type: array
          items:
            type: string
          example: ["biology","grade8"]
        difficulty:
          type: string
          enum: [easy, medium, hard]
          example: medium
        authorId:
          type: string
        createdAt:
          type: string
          format: date-time

    LessonCreate:
      type: object
      required:
        - title
        - content
      properties:
        title:
          type: string
        content:
          type: string
          description: "Markdown or sanitized HTML content"
        tags:
          type: array
          items:
            type: string
        difficulty:
          type: string
          enum: [easy, medium, hard]

    AIExplainRequest:
      type: object
      required:
        - prompt
      properties:
        prompt:
          type: string
          example: "Explain Pythagoras theorem for grade 8 students"
        tone:
          type: string
          enum: [basic, intermediate, advanced]
          example: basic
        context:
          type: string
          description: "Optional lesson or prior conversation context"

    AIExplainResponse:
      type: object
      properties:
        response:
          type: string
          example: "Pythagoras theorem states that..."
        sources:
          type: array
          items:
            type: string

    AIQuizRequest:
      type: object
      required:
        - topic
      properties:
        topic:
          type: string
          example: "Photosynthesis"
        numQuestions:
          type: integer
          minimum: 1
          maximum: 20
          default: 5
        difficulty:
          type: string
          enum: [easy, medium, hard]
          example: easy

    GeneratedQuizResponse:
      type: object
      properties:
        title:
          type: string
          example: "Quiz: Photosynthesis"
        questions:
          type: array
          items:
            $ref: '#/components/schemas/QuizQuestion'

    QuizQuestion:
      type: object
      properties:
        id:
          type: string
          example: "q1"
        question:
          type: string
          example: "What is the main pigment used in photosynthesis?"
        options:
          type: array
          items:
            type: string
        correctIndex:
          type: integer
          description: "Index of the correct option (server-only, not returned to student)"
        explanation:
          type: string
          example: "Chlorophyll is the primary pigment because..."

    QuizCreate:
      type: object
      required:
        - title
        - questions
      properties:
        title:
          type: string
        generatedFrom:
          type: string
          description: "Lesson id or free-text topic"
        questions:
          type: array
          items:
            type: object
            required:
              - question
              - options
              - correctIndex
            properties:
              question: { type: string }
              options:
                type: array
                items: { type: string }
              correctIndex:
                type: integer
              explanation:
                type: string

    Quiz:
      type: object
      properties:
        id:
          type: string
        title:
          type: string
        generatedFrom:
          type: string
        questions:
          type: array
          items:
            $ref: '#/components/schemas/QuizQuestion'
        analytics:
          type: object
          properties:
            timesTaken: { type: integer, example: 12 }
            avgScore: { type: number, format: float, example: 78.5 }

    QuizSummary:
      type: object
      properties:
        id: { type: string }
        title: { type: string }
        createdBy: { type: string }
        createdAt: { type: string }

    QuizSubmission:
      type: object
      required:
        - answers
      properties:
        answers:
          type: array
          items:
            type: string
          description: "Array of selected option identifiers or values"

    QuizResult:
      type: object
      properties:
        quizId:
          type: string
        totalQuestions:
          type: integer
        score:
          type: integer
        percentage:
          type: number
        details:
          type: array
          items:
            type: object
            properties:
              questionId: { type: string }
              correct: { type: boolean }
              userAnswer: { type: string }
              explanation: { type: string }

    AISummarizeRequest:
      type: object
      required:
        - text
      properties:
        text:
          type: string
        length:
          type: string
          enum: [short, medium, long]
          default: medium

security:
  - bearerAuth: []

externalDocs:
  description: Complete system docs and examples
  url: /docs/API_DOCUMENTATION.yml
